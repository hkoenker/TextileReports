---
title: "ITN Textile vs ITN Use"
description: |
  Does the textile of an ITN make a difference in the overall use rate? <br>  Last update: `r format(Sys.time(), '%d %B, %Y')`
site: distill::distill_website
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(janitor)
library(maptools)
library(maps)
library(broom)
library(spData)
library(sf)
library(cowplot)
```

This website provides [reports](docs/reports.html) for countries in sub-Saharan Africa to evaluate whether there are differences in use of insecticide-treated nets (ITNs) due to the textile of ITNs (i.e. polyester or polyethylene).

Some countries may wish to procure ITNs of a particular textile. These reports use large household survey data to evaluate whether there are differences in use between polyester and polyethylene nets in a particular country, and whether net textile is associated with these differences after controlling for other determinants of net use.

These [reports](docs/reports.html) walk through several key questions to ask as we consider this question and provide recommendations for next steps.

This work is supported by the Alliance for Malaria Prevention with funding from The Bill & Melinda Gates Foundation.

```{r read}
# read in data, tag most recent survey per country, clean country names for joining
df <- read_excel("/Users/hannahkoenker/Dropbox/A DHS MIS Datasets/Analysis/Textile/textile_use_m.xlsx") %>% 
  clean_names() %>% 
  mutate(diffuse=abs(percent_of_polyester_nets_used - percent_of_polyethylene_nets_used),
         country = str_replace_all(country, "[:digit:]", ""),
         country = str_replace_all(country, " -", ""),
         country = str_trim(country)) %>% 
  group_by(country) %>%
  slice(which.max(year)) %>% 
  mutate(diff5 = if_else(diffuse>5,">5 points difference","<=5 points difference"),
         country = case_when(
           country == "GuineaBissau" ~ "Guinea-Bissau",
           country == "Gambia" ~ "The Gambia",
           country == "Congo" ~ "Republic of Congo",
           country == "DRC" ~ "Democratic Republic of the Congo",
           country == "CAR" ~ "Central African Republic",
           TRUE ~ as.character(country)
         ),
         diff = if_else(p_value>0.05,-1,diffuse),
         diff = cut(diff,breaks=c(-2,0,5,10,15,Inf)),
         name = country)
```

```{r worldmap}
africa = world %>% 
  filter(continent == "Africa", !is.na(iso_a2)) %>% 
  left_join(worldbank_df, by = "iso_a2") %>% 
  dplyr::select(name, subregion) %>% 
  left_join(df, by="name") %>% 
  st_transform("+proj=aea +lat_1=20 +lat_2=-23 +lat_0=0 +lon_0=25")

```

```{r make_sf}
crs_africa <-  st_crs(africa)
```

``` {r map_5ptsdiff}
m5pt <- ggplot(africa) +
  geom_sf(data = africa, aes(fill = factor(diff)),
          color = "lightgrey") +
  coord_sf(crs = st_crs(africa)) +
  theme_void() +
  scale_fill_brewer(
    # values = c("gray", "thistle", "plum", "orchid"),
    palette = "BuPu",
    na.value = "WhiteSmoke",
    labels = c("no difference",
    "<5 pts",
               "5-9.9 pts",
               "10-15 pts")
  ) +
  labs(fill = "Use difference",
       color = "",
       title = "Crude difference in % of nets used between textiles",
       caption = "Data source: most recent DHS, MIS, MICS") +
  theme(plot.margin = grid::unit(c(0, 0, 0, 0), "null"))

m5pt
# 
# ggsave("diff5points_map.png")
```

``` {r map_sigmultivar}
aft <- africa %>%
  mutate(
    aor_for_textile = if_else(is.na(p_0_05_aor), 1, aor_for_textile),
    aor_for_textile = ifelse(is.na(country), NA, aor_for_textile),
    melogit_aor = if_else(
      is.na(melogit_star),
      1,
      note_aor_is_controlling_for_net_supply_region_ses_residence_month
    )
  )

ggplot(aft) +
  geom_sf(data = aft, aes(fill = aor_for_textile), color = "lightgray") +
  coord_sf(crs = st_crs(aft)) +
  theme_void() +
  scale_fill_gradient2(
    low = "lightcoral",
    mid = "ghostwhite",
    high = "lightblue",
    midpoint = 1.0,
    na.value = "WhiteSmoke"
  ) +
  annotate(
    "text",
    x = 1900000,
    y = 2700000,
    label = "Polyester more \nlikely to be used",
    size = 2.5,
    color = "lightcoral",
    fontface = "bold"
  ) +
  annotate(
    "text",
    x = -3000000,
    y = -700000,
    label = "Polyethylene more \nlikely to be used",
    size = 2.5,
    color = "cadetblue",
    fontface = "bold"
  ) +
  annotate(
    "text",
    x = -2500000,
    y = -2750000,
    label = "No correlation",
    size = 2.5,
    color = "#696969",
    fontface = "bold"
  ) +
  # geom_curve(aes(x = -2000000, y = -2500000, xend = -100000, yend = -500000),
  #   arrow = arrow(length = unit(0.08, "inch")), size = 0.5,
  #   color = "grey", curvature = 0.3) +
  geom_curve(
    aes(
      x = -2000000,
      y = -2500000,
      xend = -1400000,
      yend = -1500000
    ),
    arrow = arrow(length = unit(0.08, "inch")),
    size = 0.5,
    color = "grey",
    curvature = -0.3
  ) +
  geom_curve(
    aes(
      x = 1000000,
      y = 2700000,
      xend = -250000,
      yend = 2500000
    ),
    arrow = arrow(length = unit(0.08, "inch")),
    size = 0.5,
    color = "lightcoral",
    curvature = 0.3
  ) +
  geom_curve(
    aes(
      x = -4000000,
      y = -300000,
      xend = -4000000,
      yend = 1250000
    ),
    arrow = arrow(length = unit(0.08, "inch")),
    size = 0.5,
    color = "cadetblue",
    curvature = -0.3
  ) +
  labs(
    fill = "Adjusted odds ratio",
    title = "Multivariate model",
    subtitle = "Correlation of textile with use: \nadjusted for household supply of nets, net age, region, \nwealth, urban/rural, net age, and month",
    caption = "Data source: most recent DHS, MIS, MICS."
  ) +
  theme(plot.margin = grid::unit(c(0, 0, 0, 0), "null"))


    # title = "Textile significantly correlated with use in multivariate model"
# ggsave("multivarsignif_map.png")
```

``` {r map_sigmelogit}
# mel <- ggplot(africa) +
#   geom_sf(data = africa, aes(fill = factor(melogit_p_value<0.05)),
#           color = "lightgray") +
#   coord_sf(crs = st_crs(africa)) +
#   theme_void() +
#   scale_fill_manual(values = c("gray","steelblue"),
#                     na.value = "WhiteSmoke",
#                     labels = c("No",
#                                "Yes")) +
#   labs(fill = "",
#        title = "Multilevel mixed-effects logistic regression model",
#        subtitle = "Textile significantly correlated with use, \nadjusted for household supply of nets, region, wealth, urban/rural, and month",
#        caption = "Data source: most recent DHS, MIS, MICS") +
#   theme(plot.margin = grid::unit(c(0, 0, 0, 0), "null"))
# mel
# title = "Textile significantly correlated with use in multivariate model"
# ggsave("multivarsignif_map.png")
```

``` {r map_melogit2}
# Mixed effects results - not weighted for surveys! accounts for clustering within the cluster but not at household level.

# 
# mel2 <- ggplot(aft) +
#   geom_sf(data = aft, aes(fill = melogit_aor),
#           color = "lightgray") +
#   coord_sf(crs = st_crs(aft)) +
#   theme_void() +
#   scale_fill_gradient2(
#     low = "lightcoral",
#     mid = "ghostwhite",
#     high = "lightblue",
#     midpoint = 1.0,
#     na.value = "WhiteSmoke"
#   ) +
#   labs(fill = "",
#        title = "Multilevel mixed-effects logistic regression model",
#        subtitle = "Textile significantly correlated with use, \nadjusted for household supply of nets, net age, region, wealth, urban/rural, and month",
#        caption = "Data source: most recent DHS, MIS, MICS") +
#   theme(plot.margin = grid::unit(c(0, 0, 0, 0), "null"))
# mel2

```

```{r twomaps}
# plot_grid(m5pt, mmv, labels = c('A', 'B'), label_size = 12)
```

```{r}

# 
# 
# test <- ggplot(africa) +
#   geom_sf(
#     data = africa, aes(color = factor(p_0_05_aor))) +
#       coord_sf(crs = st_crs(africa)) +
#       theme_void() +
#     scale_color_manual(
#         values = c("red"),
#         na.value = "white",
#         labels = c("p<0.05"),
#         breaks = levels(as.factor(africa$p_0_05_aor))
#       ) +
#       labs(
#         fill = "Adjusted odds of polyethylene net being used (vs polyester)",
#         color = "",
#         title = "Textile significantly correlated with use in multivariate model"
#       ) +
#       theme(plot.margin = grid::unit(c(0, 0, 0, 0), "null"))
# test
```

